<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF & File Metadata Viewer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .drop-zone {
            border: 2px dashed #cbd5e0; /* border-gray-300 */
            background-color: #f7fafc; /* bg-gray-50 */
            transition: all 0.2s ease-in-out;
        }
        .dark .drop-zone {
            border-color: #4a5568; /* border-gray-600 */
            background-color: #2d3748; /* bg-gray-800 */
        }
        .drop-zone.drag-over {
            border-color: #4299e1; /* border-blue-500 */
            background-color: #ebf8ff; /* bg-blue-50 */
        }
        .dark .drop-zone.drag-over {
            border-color: #63b3ed; /* border-blue-400 */
            background-color: #2c5282; /* bg-blue-800 */
        }
        /* Custom scrollbar for gallery and exif table */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbar if needed */
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for table section headers */
        .table-section-header {
            background-color: #edf2f7; /* Tailwind gray-200 */
            color: #2d3748; /* Tailwind gray-800 */
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #e2e8f0; /* Tailwind gray-300 */
            border-bottom: 1px solid #e2e8f0; /* Tailwind gray-300 */
        }
        .dark .table-section-header {
            background-color: #4a5568; /* Tailwind gray-700 */
            color: #e2e8f0; /* Tailwind gray-300 */
            border-color: #718096; /* Tailwind gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen flex flex-col">

    <div class="flex-grow flex flex-col md:flex-row p-4 space-y-4 md:space-y-0 md:space-x-4 h-full">
        <!-- Left Panel: Image Preview/Gallery -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex flex-col overflow-hidden relative">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Image Preview / Gallery</h2>
            <button id="closePreviewButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white focus:outline-none hidden z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- File Input and Drag/Drop Zone -->
            <div id="fileSelectorContainer" class="mb-6">
                <label for="fileInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Images or a Folder:</label>
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                <input type="file" id="folderInput" webkitdirectory directory accept="image/*" class="hidden">

                <div id="dropZone" class="drop-zone flex flex-col items-center justify-center p-8 rounded-lg cursor-pointer text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                    <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 0115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-lg font-medium text-center">Drag & Drop Images here</p>
                    <p class="text-sm">or <span class="text-blue-600 font-semibold cursor-pointer" id="browseFilesButton">click to browse files</span></p>
                    <p class="text-sm">or <span class="text-blue-600 font-semibold cursor-pointer" id="browseFolderButton">select a folder</span></p>
                </div>
            </div>

            <!-- Preview/Gallery Container -->
            <div id="imageDisplay" class="flex-grow flex flex-col bg-gray-50 dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                <p class="text-gray-500 dark:text-gray-400 text-center py-8" id="initialMessage">Drop images or select files/a folder to get started!</p>
                <div id="singleImagePreview" class="hidden flex justify-center items-center h-96 mb-3">
                    <img id="currentImage" src="" alt="Selected Image Preview" class="max-w-full max-h-full object-contain rounded-md shadow-lg">
                </div>
                <div class="flex-grow h-0 overflow-y-auto">
                    <div id="imageGallery" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <!-- Images will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: EXIF Data Table -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">EXIF Data</h2>
              <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                  <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                  <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
              </button>
            </div>
            <div id="exifDataTableContainer" class="flex-grow overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                <table id="exifDataTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600 hidden">
                    <thead class="bg-gray-100 dark:bg-gray-600">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tl-md">Tag</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tr-md">Value</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                        <!-- EXIF and File metadata will be populated here -->
                    </tbody>
                </table>
                <p class="text-gray-500 dark:text-gray-400 text-center py-8" id="exifInitialMessage">EXIF and file metadata will appear here after image selection.</p>
            </div>
        </div>
    </div>

    <!-- Modal for Confirm/Alert -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="modalMessage" class="text-gray-800 dark:text-gray-200 mb-6">Modal message goes here.</p>
            <div id="modalButtons" class="flex justify-end space-x-3">
                <button id="modalCancelButton" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-800">Cancel</button>
                <button id="modalConfirmButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Replaced exif-js with the more modern exifr library -->
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>

    <script>
        // --- Simple Logger ---
        const logger = {
            _log(level, ...args) {
                const timestamp = new Date().toLocaleTimeString();
                console[level](`[${timestamp}]`, ...args);
            },
            log(...args) { this._log('log', ...args); },
            warn(...args) { this._log('warn', ...args); },
            error(...args) { this._log('error', ...args); }
        };
        logger.log("App initialized.");

        // DOM Element References
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const dropZone = document.getElementById('dropZone');
        const browseFilesButton = document.getElementById('browseFilesButton');
        const browseFolderButton = document.getElementById('browseFolderButton');
        const initialMessage = document.getElementById('initialMessage');
        const exifInitialMessage = document.getElementById('exifInitialMessage');
        const singleImagePreview = document.getElementById('singleImagePreview');
        const currentImage = document.getElementById('currentImage');
        const imageGallery = document.getElementById('imageGallery');
        const exifDataTable = document.getElementById('exifDataTable');
        const exifDataTableBody = exifDataTable.querySelector('tbody');
        const fileSelectorContainer = document.getElementById('fileSelectorContainer');
        const closePreviewButton = document.getElementById('closePreviewButton');

        // Modal DOM References
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');

        // --- MODAL LOGIC ---
        let confirmCallback = null;
        let cancelCallback = null;

        function hideModal() {
            customModal.classList.add('hidden');
        }

        function showModal(message, onConfirm, onCancel) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            cancelCallback = onCancel;
            if (onCancel) {
                modalCancelButton.classList.remove('hidden');
            } else {
                modalCancelButton.classList.add('hidden');
            }
            modalConfirmButton.textContent = onCancel ? 'Confirm' : 'OK';
            customModal.classList.remove('hidden');
        }

        modalConfirmButton.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            hideModal();
        });

        modalCancelButton.addEventListener('click', () => {
            if (cancelCallback) cancelCallback();
            hideModal();
        });

        function showAlert(message) {
            showModal(message, () => {}, null);
        }
        
        // Event Listeners
        browseFilesButton.addEventListener('click', () => fileInput.click());
        browseFolderButton.addEventListener('click', () => folderInput.click());
        fileInput.addEventListener('change', handleFiles);
        folderInput.addEventListener('change', handleFiles);
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
        closePreviewButton.addEventListener('click', confirmClosePreview);

        // (FIX) Updated logic to handle initial message visibility more cleanly.
        function clearContent(showSelector = true) {
            logger.log(`Clearing display. Show selector: ${showSelector}`);
            
            if (showSelector) {
                // If we are showing the file selector, show the initial message.
                initialMessage.classList.remove('hidden');
            } else {
                // If we are hiding the selector to show a preview, hide the initial message.
                initialMessage.classList.add('hidden');
            }

            exifInitialMessage.classList.remove('hidden');
            singleImagePreview.classList.add('hidden');
            imageGallery.classList.add('hidden');
            imageGallery.innerHTML = '';
            exifDataTable.classList.add('hidden');
            exifDataTableBody.innerHTML = '';
            if (showSelector) {
                fileSelectorContainer.classList.remove('hidden');
                closePreviewButton.classList.add('hidden');
            } else {
                fileSelectorContainer.classList.add('hidden');
                closePreviewButton.classList.remove('hidden');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // (FIX) Removed redundant line that was hiding the initial message.
        async function handleFiles(event) {
            logger.log(`Handling files from event: ${event.type}`);
            
            let files;
            if (event.type === 'change') {
                files = event.target.files;
            } else if (event.type === 'drop') {
                files = event.dataTransfer.files;
            }

            if (!files || files.length === 0) {
                logger.warn("File selection was cancelled or no files were chosen.");
                return;
            }
            
            clearContent(false);
            logger.log(`Found ${files.length} total files.`);

            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            logger.log(`Filtered to ${imageFiles.length} image files.`);

            if (imageFiles.length === 0) {
                showAlert('No valid image files found. Please select images or a folder containing them.');
                clearContent(true);
                return;
            }
            
            if (imageFiles.length === 1) {
                await displaySingleImage(imageFiles[0]);
            } else {
                await displayImageGallery(imageFiles);
            }
        }

        async function displaySingleImage(file, inGalleryMode = false) {
            logger.log(`Displaying single image: ${file.name}`);
            singleImagePreview.classList.remove('hidden');
            if (!inGalleryMode) {
                imageGallery.classList.add('hidden');
            }
            exifInitialMessage.classList.add('hidden');
            exifDataTable.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage.src = e.target.result;
                logger.log(`Image preview has been set for ${file.name}`);
            };
            reader.readAsDataURL(file);

            try {
                const exifTags = await exifr.parse(file);
                logger.log(`Successfully parsed EXIF data for ${file.name}`, exifTags || 'No EXIF data found.');
                const fileMetadata = {
                    'File Name': file.name,
                    'File Size': formatBytes(file.size),
                    'File Type': file.type,
                    'Last Modified': new Date(file.lastModified).toLocaleString()
                };
                populateExifTable(fileMetadata, exifTags || {});
            } catch (error) {
                logger.error(`Error parsing EXIF data for ${file.name}:`, error);
                const fileMetadata = {
                    'File Name': file.name,
                    'File Size': formatBytes(file.size),
                    'File Type': file.type,
                    'Last Modified': new Date(file.lastModified).toLocaleString()
                };
                populateExifTable(fileMetadata, { 'Error': 'Could not read EXIF data.' });
            }
        }

        async function displayImageGallery(imageFiles) {
            logger.log(`Displaying image gallery with ${imageFiles.length} images.`);
            imageGallery.classList.remove('hidden');
            singleImagePreview.classList.remove('hidden');
            exifInitialMessage.classList.add('hidden');
            exifDataTable.classList.remove('hidden');
            imageGallery.innerHTML = '';

            await displaySingleImage(imageFiles[0], true);

            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative group cursor-pointer rounded-md overflow-hidden shadow-sm hover:shadow-lg transition-all duration-200 ease-in-out aspect-square';
                    imgContainer.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <p class="text-white text-xs font-semibold text-center p-2 truncate w-full">${file.name}</p>
                        </div>
                    `;
                    imgContainer.addEventListener('click', () => displaySingleImage(file, true));
                    imageGallery.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
        }

        function populateExifTable(fileMetadata, exifTags) {
            logger.log("Populating metadata table.");
            exifDataTableBody.innerHTML = '';

            function addRow(tag, value) {
                const row = exifDataTableBody.insertRow();
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                const cellTag = row.insertCell();
                const cellValue = row.insertCell();
                cellTag.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200';
                cellValue.className = 'px-6 py-4 text-sm text-gray-700 dark:text-gray-300 break-words max-w-xs';
                cellTag.textContent = tag;
                cellValue.textContent = value;
            }

            const fileMetaHeaderRow = exifDataTableBody.insertRow();
            fileMetaHeaderRow.innerHTML = `<td colspan="2" class="table-section-header rounded-t-md">File Metadata</td>`;
            for (const tag in fileMetadata) {
                if (fileMetadata.hasOwnProperty(tag)) {
                    addRow(tag, fileMetadata[tag]);
                }
            }

            const exifDataHeaderRow = exifDataTableBody.insertRow();
            exifDataHeaderRow.innerHTML = `<td colspan="2" class="table-section-header mt-4">EXIF Data</td>`;
            if (Object.keys(exifTags).length === 0) {
                addRow('N/A', 'No EXIF data found for this image.');
            } else {
                for (const tag in exifTags) {
                    if (exifTags.hasOwnProperty(tag)) {
                        const value = Array.isArray(exifTags[tag]) ? exifTags[tag].join(', ') : exifTags[tag];
                        addRow(tag, value);
                    }
                }
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            handleFiles(e);
        }

        function confirmClosePreview() {
            showModal(
                'Are you sure you want to close the current preview and return to file selection?',
                () => { 
                    clearContent(true); 
                    // Reset inputs to allow re-selecting the same file
                    fileInput.value = null;
                    folderInput.value = null;
                    logger.log("Preview closed and file inputs reset.");
                },
                () => {}
            );
        }

        clearContent(true);
        // Initial reset of inputs on page load
        fileInput.value = null;
        folderInput.value = null;

        // Theme Toggle Script
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeIconLight.classList.add('hidden');
            themeIconDark.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeIconLight.classList.remove('hidden');
            themeIconDark.classList.add('hidden');
        }

        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                localStorage.setItem('theme', 'light');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
